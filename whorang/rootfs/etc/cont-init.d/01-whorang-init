#!/usr/bin/env bash
# ==============================================================================
# WhoRang AI Doorbell Add-on
# s6-overlay container initialization script
# ==============================================================================

# This script runs once when the container starts, before any services.
# It is responsible for setting up the environment for all s6 services.

# Safely attempt to source bashio, but do not fail if it's unavailable.
# This ensures compatibility with both HA and standalone Docker environments.
BASHIO_IS_AVAILABLE="false"
if [ -f "/usr/lib/bashio/bashio.sh" ]; then
    # Redirect errors to /dev/null to prevent script failure if bashio's
    # own dependencies (like /const.sh) are missing.
    # shellcheck source=/usr/lib/bashio/bashio.sh
    source /usr/lib/bashio/bashio.sh 2>/dev/null
    # After attempting to source, verify that the bashio command is actually available.
    if command -v bashio >/dev/null 2>&1; then
        BASHIO_IS_AVAILABLE="true"
    fi
fi

# Function to log messages, using bashio if it was successfully sourced.
log_info() {
    if [ "${BASHIO_IS_AVAILABLE}" = "true" ] && bashio::supervisor.ping >/dev/null 2>&1; then
        bashio::log.info "$1"
    else
        echo "[Init] $1"
    fi
}

log_info "Starting WhoRang one-time initialization..."



# Create the s6 environment directory if it doesn't exist
mkdir -p /var/run/s6/container_environment

# Determine run mode (Home Assistant Add-on vs. Standalone)
WHORANG_ADDON_MODE="false"
if [ -f "/data/options.json" ]; then
    log_info "Home Assistant Add-on mode detected."
    WHORANG_ADDON_MODE="true"
else
    log_info "Standalone mode detected."
fi
printf "%s" "${WHORANG_ADDON_MODE}" > /var/run/s6/container_environment/WHORANG_ADDON_MODE

# Load configuration based on mode
if [ "${WHORANG_ADDON_MODE}" = "true" ] && [ "${BASHIO_IS_AVAILABLE}" = "true" ]; then
    log_info "Loading configuration from Home Assistant add-on options via bashio..."
    AI_PROVIDER=$(bashio::config 'ai_provider')
    LOG_LEVEL=$(bashio::config 'log_level')
    DATABASE_PATH=$(bashio::config 'database_path')
    UPLOADS_PATH=$(bashio::config 'uploads_path')
    MAX_UPLOAD_SIZE=$(bashio::config 'max_upload_size')
    FACE_RECOGNITION_THRESHOLD=$(bashio::config 'face_recognition_threshold')
    AI_ANALYSIS_TIMEOUT=$(bashio::config 'ai_analysis_timeout')
    WEBSOCKET_ENABLED=$(bashio::config 'websocket_enabled')
    CORS_ENABLED=$(bashio::config 'cors_enabled')
    PUBLIC_URL=$(bashio::config 'public_url')
    CORS_ORIGINS=$(bashio::config 'cors_origins' | paste -sd ',' -)
elif [ "${WHORANG_ADDON_MODE}" = "true" ]; then
    log_info "Loading configuration from /data/options.json using jq..."
    AI_PROVIDER=$(jq -r '.ai_provider // "local"' /data/options.json)
    LOG_LEVEL=$(jq -r '.log_level // "info"' /data/options.json)
    DATABASE_PATH=$(jq -r '.database_path // "/data/whorang.db"' /data/options.json)
    UPLOADS_PATH=$(jq -r '.uploads_path // "/data/uploads"' /data/options.json)
    MAX_UPLOAD_SIZE=$(jq -r '.max_upload_size // 10' /data/options.json)
    FACE_RECOGNITION_THRESHOLD=$(jq -r '.face_recognition_threshold // 0.8' /data/options.json)
    AI_ANALYSIS_TIMEOUT=$(jq -r '.ai_analysis_timeout // 30' /data/options.json)
    WEBSOCKET_ENABLED=$(jq -r '.websocket_enabled // true' /data/options.json)
    CORS_ENABLED=$(jq -r '.cors_enabled // true' /data/options.json)
    PUBLIC_URL=$(jq -r '.public_url // ""' /data/options.json)
    CORS_ORIGINS=$(jq -r '(.cors_origins | join(",")) // "*"' /data/options.json)
else
    log_info "Loading configuration from environment variables (standalone mode)..."
    AI_PROVIDER=${AI_PROVIDER:-local}
    LOG_LEVEL=${LOG_LEVEL:-info}
    DATABASE_PATH=${DATABASE_PATH:-/data/whorang.db}
    UPLOADS_PATH=${UPLOADS_PATH:-/data/uploads}
    MAX_UPLOAD_SIZE=${MAX_UPLOAD_SIZE:-10}
    FACE_RECOGNITION_THRESHOLD=${FACE_RECOGNITION_THRESHOLD:-0.8}
    AI_ANALYSIS_TIMEOUT=${AI_ANALYSIS_TIMEOUT:-30}
    WEBSOCKET_ENABLED=${WEBSOCKET_ENABLED:-true}
    CORS_ENABLED=${CORS_ENABLED:-true}
    CORS_ORIGINS=${CORS_ORIGINS:-*}
    PUBLIC_URL=${PUBLIC_URL:-}
fi

# Write all variables to the s6 environment directory for services to inherit
log_info "Exporting configuration for services..."
printf "%s" "${AI_PROVIDER}" > /var/run/s6/container_environment/AI_PROVIDER
printf "%s" "${LOG_LEVEL}" > /var/run/s6/container_environment/LOG_LEVEL
printf "%s" "${DATABASE_PATH}" > /var/run/s6/container_environment/DATABASE_PATH
printf "%s" "${UPLOADS_PATH}" > /var/run/s6/container_environment/UPLOADS_PATH
printf "%s" "${MAX_UPLOAD_SIZE}" > /var/run/s6/container_environment/MAX_UPLOAD_SIZE
printf "%s" "${FACE_RECOGNITION_THRESHOLD}" > /var/run/s6/container_environment/FACE_RECOGNITION_THRESHOLD
printf "%s" "${AI_ANALYSIS_TIMEOUT}" > /var/run/s6/container_environment/AI_ANALYSIS_TIMEOUT
printf "%s" "${WEBSOCKET_ENABLED}" > /var/run/s6/container_environment/WEBSOCKET_ENABLED
printf "%s" "${CORS_ENABLED}" > /var/run/s6/container_environment/CORS_ENABLED
printf "%s" "${PUBLIC_URL}" > /var/run/s6/container_environment/PUBLIC_URL
printf "%s" "${CORS_ORIGINS}" > /var/run/s6/container_environment/CORS_ORIGINS

# Set fixed Node.js environment variables
printf "%s" "production" > /var/run/s6/container_environment/NODE_ENV
printf "%s" "3001" > /var/run/s6/container_environment/PORT

# Standalone mode requires adjusting nginx config for external access
if [ "${WHORANG_ADDON_MODE}" = "false" ]; then
    log_info "Applying standalone network configuration for nginx..."
    if [ -f /etc/nginx/conf.d/default.conf ]; then
        sed -i '/allow 172\.30\.32\.2;/c\    allow all;' /etc/nginx/conf.d/default.conf
    fi
fi

log_info "WhoRang initialization complete."
