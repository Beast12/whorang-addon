#!/usr/bin/with-contenv bashio

# Start nginx with proper configuration for Home Assistant add-on
bashio::log.info "Starting nginx..."

# Remove default nginx configurations that might conflict
rm -f /etc/nginx/sites-enabled/* 2>/dev/null || true
rm -f /etc/nginx/sites-available/* 2>/dev/null || true

# Check if running in standalone mode and adjust access control
if [ "$WHORANG_ADDON_MODE" = "false" ]; then
    # Replace restrictive access control with allow all for standalone mode
    sed -i '/allow 172\.30\.32\.2;/,/# Note: In standalone mode, run\.sh will replace this with/c\
    # Standalone mode - allow all access\
    allow all;' /etc/nginx/conf.d/default.conf 2>/dev/null || true
fi

# Validate nginx configuration
if ! nginx -t; then
    bashio::log.error "Nginx configuration test failed"
    exit 1
fi

# Start nginx in foreground mode
exec nginx -g "error_log /dev/stderr info; access_log /dev/stdout; daemon off; master_process off; worker_processes 1;"
